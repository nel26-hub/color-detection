<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Picker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
</head>
<body>
<input type="file" id="fileInput" accept="image/*">
<script>
let img;
let imgWidth, imgHeight;
let uploadedFile;

let xWhite, yWhite;
let xColor, yColor;

let runWhite = false;
let whitePrompt = false;
let whiteDirections = false;
let whitePicked = false;

let runColor = false;
let colorPrompt = false;
let colorDirections = false;
let colorPicked = false;
let finishedPicking = false;

let createButtons = false;

let d;

function setup() {
  createCanvas(900, 800);
  background(255);
  textSize(20);
  d = new DetectColor();

  // File input listener
  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', (event) => {
    uploadedFile = event.target.files[0];
    if (uploadedFile) {
      loadImage(URL.createObjectURL(uploadedFile), (loadedImg) => {
        img = loadedImg;
        // Resize if too big
        const maxW = 800;
        const maxH = 600;
        if (img.width > maxW || img.height > maxH) {
          const scale = min(maxW / img.width, maxH / img.height);
          imgWidth = img.width * scale;
          imgHeight = img.height * scale;
        } else {
          imgWidth = img.width;
          imgHeight = img.height;
        }
        runWhite = true;
        whitePrompt = true;
      });
    }
  });
}

function draw() {
  background(255);

  if (img) {
    image(img, 50, 100, imgWidth, imgHeight);
  }

  fill(0);
  textSize(25);

  if (!img) {
    text("Upload an image to start", 50, 50);
    return;
  }

  if (whitePrompt) {
    fill(255, 0, 0);
    text("Click on the white circle", 50, 50);
  }

  if (whiteDirections) {
    fill(255,0,0);
    ellipse(xWhite, yWhite, 5);
    fill(0);
    text("This is where the white color will be recorded", 50, 20);
    text("Press CONFIRM to confirm white color choice",50,55);
    text("Press RESET to choose a different spot for white color", 50, 90);
    createButtons = true;
  }

  if (colorPrompt) {
    fill(255, 0, 0);
    text("Click on the purple circle", 50, 50);
    fill(0);
    ellipse(xWhite, yWhite, 5); // keep white point visible
  }

  if (colorDirections) {
    fill(0);
    ellipse(xWhite, yWhite, 5);
    fill(255,0,0);
    ellipse(xColor, yColor, 5);
    fill(0);
    text("This is where the purple color will be recorded", 50, 20);
    text("Press CONFIRM to confirm purple color choice",50,55);
    text("Press RESET to choose a different spot for purple color", 50, 90);
    createButtons = true;
  }

  if (finishedPicking) {
    let c = d.colors();
    background(c[0], c[2], c[1]);
    fill(c[3], c[5], c[4]);
    let s = d.getColorValues();
    textSize(20);
    text("Red: " + s[0] + ", Blue: " + s[1] + ", Green: " + s[2], 50, 50);
    textSize(30);
    text("Adjusted for lighting, camera quality, etc.:",50,90);
    text("Red: " + s[3] + ", Blue: " + s[4] + ", Green: " + s[5], 50, 130);
    text("CF diagnosis: (will add later)", 50, 170);
  }

  if (createButtons) {
    drawButtons();
  }
}

function mousePressed() {
  if (runWhite && whitePrompt) {
    xWhite = mouseX;
    yWhite = mouseY;
    whitePrompt = false;
    whiteDirections = true;
    whitePicked = true;
    d.whiteCircle(floor((xWhite - 50) * (img.width / imgWidth)), floor((yWhite - 100) * (img.height / imgHeight)), img);
  } else if (runColor && colorPrompt) {
    xColor = mouseX;
    yColor = mouseY;
    colorPrompt = false;
    colorDirections = true;
    colorPicked = true;
    d.purple(floor((xColor - 50) * (img.width / imgWidth)), floor((yColor - 100) * (img.height / imgHeight)), img);
  }

  // Buttons for white
  if (whiteDirections && mouseX > 20 && mouseX < 102 && mouseY > 120 && mouseY < 140) {
    runWhite = false;
    runColor = true;
    colorPrompt = true;
    createButtons = false;
    whiteDirections = false;
  } else if (whiteDirections && mouseX > 120 && mouseX < 185 && mouseY > 120 && mouseY < 140) {
    whitePicked = false;
    whitePrompt = true;
    whiteDirections = false;
    createButtons = false;
  }

  // Buttons for color
  if (colorDirections && mouseX > 20 && mouseX < 102 && mouseY > 120 && mouseY < 140) {
    finishedPicking = true;
    runColor = false;
    colorDirections = false;
    createButtons = false;
  } else if (colorDirections && mouseX > 120 && mouseX < 185 && mouseY > 120 && mouseY < 140) {
    colorPicked = false;
    colorPrompt = true;
    colorDirections = false;
    createButtons = false;
  }
}

function drawButtons() {
  fill(255);
  rect(20, 120, 82, 20);
  rect(120, 120, 65, 20);
  fill(0);
  textSize(15);
    text("CONFIRM", 23, 135);
    text("RESET", 126, 135);
}

// ------------------ DetectColor class ------------------
class DetectColor {
  constructor() {
    this.whiter = 0;
    this.whiteb = 0;
    this.whiteg = 0;
    this.scaleR = 1;
    this.scaleB = 1;
    this.scaleG = 1;
    this.correctedR = 0;
    this.correctedB = 0;
    this.correctedG = 0;
    this.r = 0;
    this.b = 0;
    this.g = 0;
    this.s = [];
  }

  whiteCircle(x, y, imageRef) {
    let c = imageRef.get(x, y);
    this.whiter = red(c);
    this.whiteb = blue(c);
    this.whiteg = green(c);
  }

  purple(x, y, imageRef) {
    let c = imageRef.get(x, y);
    this.r = red(c);
    this.b = blue(c);
    this.g = green(c);

    this.scaleR = 255 / this.whiter;
    this.scaleB = 255 / this.whiteb;
    this.scaleG = 255 / this.whiteg;

    this.correctedR = constrain(this.r * this.scaleR, 0, 255);
    this.correctedB = constrain(this.b * this.scaleB, 0, 255);
    this.correctedG = constrain(this.g * this.scaleG, 0, 255);
  }

  getColorValues() {
    if (this.s.length < 7) {
      this.s.push(int(this.r), int(this.b), int(this.g), int(this.correctedR), int(this.correctedB), int(this.correctedG));
    }
    return this.s;
  }

  colors() {
    return [
      int(this.whiter * this.scaleR),
      int(this.whiteb * this.scaleB),
      int(this.whiteg * this.scaleG),
      int(this.correctedR),
      int(this.correctedB),
      int(this.correctedG)
    ];
  }
}
</script>
</body>
</html>
